# Adapted from mujoco-py image
# docker build -f DockerfileLearnToRunGPUBase -t learn-to-run-gpu-base .
# We need the CUDA base dockerfile to enable GPU rendering
# on hosts with GPUs.
# The image below is a pinned version of nvidia/cuda:9.1-cudnn7-devel-ubuntu16.04 (from Jan 2018)
# If updating the base image, be sure to test on GPU since it has broken in the past.
FROM nvidia/cuda@sha256:4df157f2afde1cb6077a191104ab134ed4b2fd62927f27b69d788e8e79a45fa1
LABEL author="Stanford Surreal team"

RUN apt-get update -q \
    && DEBIAN_FRONTEND=noninteractive apt-get install -y \
    curl \
    git \
    cmake \ 
    unzip \
    bzip2 \
    wget \
    libgl1-mesa-dev \
    libgl1-mesa-glx \
    libglew-dev \
    libosmesa6-dev \
    software-properties-common \
    net-tools \
    unzip \
    vim \
    virtualenv \
    wget \
    xpra \
    xserver-xorg-dev \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

RUN curl -o /usr/local/bin/patchelf https://s3-us-west-2.amazonaws.com/openai-sci-artifacts/manual-builds/patchelf_0.9_amd64.elf \
    && chmod +x /usr/local/bin/patchelf

ENV LANG C.UTF-8
ENV LD_LIBRARY_PATH /usr/local/nvidia/lib64:${LD_LIBRARY_PATH}

# Miniconda
WORKDIR /mylibs
RUN curl -LO http://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh \
	&& bash Miniconda3-latest-Linux-x86_64.sh -p /mylibs/miniconda -b
RUN rm /mylibs/Miniconda3-latest-Linux-x86_64.sh
ENV PATH=/mylibs/miniconda/bin:${PATH}

# python 3.6.1 is specifically required for opensim to work. 3.6.4 will break!!
RUN conda install --yes python=3.6.1
RUN conda install --yes -c kidzik opensim
RUN conda install --yes -c conda-forge lapack git
RUN pip install git+https://github.com/stanfordnmbl/osim-rl.git

# pytorch
RUN conda install --yes pytorch torchvision cuda90 -c pytorch
RUN conda install --yes ffmpeg -c conda-forge
COPY requirements.txt /mylibs/
RUN pip install -r /mylibs/requirements.txt

COPY test_learn_to_run.py /mylibs/
